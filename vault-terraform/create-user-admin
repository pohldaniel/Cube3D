export VAULT_ADDR=https://127.0.0.1:8200
export VAULT_CACERT=certs/root.crt
export VAULT_CLIENT_CERT=certs/cube-client.crt
export VAULT_CLIENT_KEY=certs/cube-client.key
export VAULT_TOKEN=hvs.VaZVJa9L6TyR88QTVITZBZL6


ACCESOR="$(./vault auth list -format=json | jq -r '.["cert/"].accessor')"
ID="$(./vault write -format=json identity/entity name="admin_cert" policies="token-policy" metadata=mail="test@test.de" | jq -r ".data.id")"

if [[ "$ID" == "" ]]; then
    ID="$(./vault read -format=json identity/entity/name/admin_cert | jq -r ".data.id")"
fi

./vault write identity/entity-alias name="admin" canonical_id=$ID mount_accessor="$ACCESOR"
./vault write auth/cert/certs/daniel_cert display_name=admin policies=user-cert certificate=@certs/admin.crt

VAR=`echo $(./vault read identity/group/name/ADMIN -format=json | jq --arg id $ID '.data.member_entity_ids += [$id]' | jq '.data.member_entity_ids | join(",")') | tr -d '"'`
./vault write identity/group/name/ADMIN member_entity_ids=$VAR

VAR=`echo $(./vault read identity/group/name/PERSON_MANAGER -format=json | jq --arg id $ID '.data.member_entity_ids += [$id]' | jq '.data.member_entity_ids | join(",")') | tr -d '"'`
./vault write identity/group/name/PERSON_MANAGER member_entity_ids=$VAR